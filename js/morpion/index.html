<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Morpion</title>
        <script src="../lib.js"></script>
        <style>
            .body{
                display: flex;
                flex-direction: row;
            }
        </style>
    </head>
    <body>
        <div class="body">
            <div>
                <canvas class="my_canvas" width="512" height="512">

                </canvas>
            </div>
            <div class="results">
                <div class='test'> Comment gagner : Mettez simplement 4 formes alignés </div><br />
            </div>
        </div>

        <script>
            onload = function () {
                $('.results')
                    .append_($('<input class="prenom bouh" placeholder="tapez votre prenom" type="text" />'))
                    .append_($('<input class="nom" placeholder="tapez votre nom" type="text" />'))
                    .append_($('<input class="submit" value="valider" type="submit" />'))

                $('.submit').onclick = function() {
                    let j1 = $('.nom').val() || 'joueur 1';
                    let j2 = $('.prenom').val() || 'joueur 2';
                    $('.nom').attr({'readonly':'','disabled':''})
                    $('.prenom').attr({'readonly':'','disabled':''})
                    $('.test').attr('color','blue');
                    console.log($('.prenom').classList.contains("bouh"))
                    $('body').append($(`<div class="player_turn">C'est à ${j1} de choisir une case</div>`));
                };

                function square(x_top ,y_top ,x_bottom, y_bottom ){
                    let context = canvas.getContext('2d');
                    context.beginPath();
                    context.moveTo(x_top,y_top);
                    context.lineTo(x_bottom-10,y_top); 
                    context.lineTo(x_bottom-10,y_bottom-10); 
                    context.lineTo(x_top,y_bottom-10); 
                    context.lineTo(x_top,y_top); 
                    context.closePath();
                    context.fillStyle = 'lightblue';
                    context.fill();
                }

                let canvas = $('.my_canvas');
                let tab_morpion = new Array(5);
                for (const [key] of tab_morpion.entries()){
                    tab_morpion[key] = new Array(5);
                    for (const [key2] of tab_morpion[key].entries())
                        tab_morpion[key][key2] = 0;
                }

                // morpion creation 
                for( let x = 0; x < 500; x+= 100){
                    for (let y = 0; y < 500; y += 100){
                        square(x,y,x+100,y+100);
                    }
                }
                let user = 1;

                function cross(x, y){
                    let context = canvas.getContext('2d');
                    context.beginPath();
                    context.moveTo(x-35,y-35);
                    context.lineTo(x+35,y+35);
                    context.moveTo(x+35,y-35);
                    context.lineTo(x-35,y+35);
                    context.lineCap = 'round';
                    context.lineWidth = 8;
                    context.stroke();
                }

                function circle(x, y){
                    let context = canvas.getContext('2d');
                    context.beginPath();
                    context = canvas.getContext('2d');
                    context.beginPath();
                    context.arc(x, y, 38, 0, 2 * Math.PI);
                    context.lineWidth = 7;
                    context.stroke();
                }

                function verify_line(){
                    for(let k = 0; k < tab_morpion.length; k++){
                        let e = tab_morpion[k];
                        let line_first = eval(e[0]+e[1]+e[2]+e[3]);
                        let line_second = eval(e[1]+e[2]+e[3]+e[4]);
                        let column_first = eval(tab_morpion[0][k]+tab_morpion[1][k]+tab_morpion[2][k]+tab_morpion[3][k]+tab_morpion[4][k]);
                        let column_second = eval(tab_morpion[0][k+1]+tab_morpion[1][k+1]+tab_morpion[2][k+1]+tab_morpion[3][k]+tab_morpion[4][k+1]);
                        if(line_first == 4 || line_second == 4 || column_first == 4 || column_second == 4)
                            return 1;
                        else if (line_first == -4 || line_second == -4 || column_first == -4 || column_second == -4)
                            return -1;
                    };
                    return 0;
                }

                function verify_diag(){
                    let diag1 = eval(tab_morpion[0][1]+tab_morpion[1][2]+tab_morpion[2][3]+tab_morpion[3][4]);
                    let diag2 = eval(tab_morpion[1][0]+tab_morpion[2][1]+tab_morpion[3][2]+tab_morpion[4][3]);
                    let diag3 = eval(tab_morpion[3][0]+tab_morpion[2][1]+tab_morpion[1][2]+tab_morpion[0][3]);
                    let diag4 = eval(tab_morpion[4][1]+tab_morpion[3][2]+tab_morpion[2][3]+tab_morpion[1][4]);
                    let diag_first = eval(tab_morpion[0][0]+tab_morpion[1][1]+tab_morpion[2][2]+tab_morpion[3][3]);
                    let diag2_first = eval(tab_morpion[4][0]+tab_morpion[3][1]+tab_morpion[2][2]+tab_morpion[1][3]);
                    let diag_second = eval(tab_morpion[1][1]+tab_morpion[2][2]+tab_morpion[3][3]+tab_morpion[4][4]);
                    let diag2_second = eval(tab_morpion[3][1]+tab_morpion[2][2]+tab_morpion[1][3]+tab_morpion[0][4]);
                    if (diag1 == 4 || diag2 == 4 || diag3 == 4 || diag4 == 4 || diag_first == 4 || diag2_first == 4 || diag_second == 4 || diag2_second == 4 )
                        return 1;
                    if (diag1 == -4 || diag2 == -4 || diag3 == -4 || diag4 == -4 || diag_first == -4 || diag2_first == -4 || diag_second == -4 || diag2_second == -4 )
                        return -1;
                    return 0;
                }

                function game(state){
                    if (state == 0)
                        return ;
                    else if (state == 1)
                        alert(`${j1} a gagné`)
                    else 
                        alert(`${j2} a gagné`)

                }

                function player_turn(){
                    if(user)
                        $('.player_turn').text(`C'est à ${j1} de choisir une case`);
                    else
                        $('.player_turn').text(`C'est à ${j2} de choisir une case`);
                }

                canvas.onclick = function (e){
                    let x = e.clientX-8;
                    let y = e.clientY-8;

                    if ( (x < 90 || x.toString().substr(x.toString().length-2,2) < 90) && (y < 90 || y.toString().substr(y.toString().length-2,2) < 90)){
                        let tab_x = (x/100).toString().substr(0,1);
                        let tab_y = (y/100).toString().substr(0,1);
                        let pixel_x = parseInt(tab_x+45);
                        let pixel_y = parseInt(tab_y+45);
                        let verif_case = tab_morpion[tab_y][tab_x];
                        if (user && verif_case == 0){
                            cross(pixel_x, pixel_y);
                            user = 0;
                            tab_morpion[tab_y][tab_x] = 1;
                            player_turn();
                            game(verify_diag());
                            game(verify_line());
                        } else if (user == 0 && verif_case == 0) {
                            circle(pixel_x, pixel_y);
                            user = 1;
                            tab_morpion[tab_y][tab_x] = -1;
                            player_turn();
                            game(verify_diag());
                            game(verify_line());   
                        }
                    }
                }
            }
        </script>
    </body>
</html>